---
layout:     post
title:      通过路由器监控家中是否停电
subtitle:   使用腾讯云函数和梅林路由器监控家中是否停电
date:       2020-9-05
author:     王帅
catalog: true
tags:
    - merlin
    - CloudBase
    - 
    - PowerShell
typora-root-url: ..
---

### 引言
由于不常在家，而最近家中的漏电保护器又有点问题；因为跳闸，冰箱中的东西损失惨重；因此开发这样一个小工具监控家中的电路通断状态。

### 解决方案

要在断电后得知家中的情况是不可能的，因为此时路由器无法工作；但是可以采用变通方案：在通电时定时记录通电状态，并定期检查这个状态；一旦一段时间未收到通电日志，即时发送消息告警。

因此，整体的方案就有了；创建一个记录路由器在线状态的服务`LogPower`和定时检查日志判断通电状态的服务`CheckPowerAndSendMsg`；在路由器中使用定时任务调用`LogPower`服务定时记录状态

通知的方式我选择的是微信，如果你常用企业微信，那你可以参考[这篇文章](https://work.weixin.qq.com/api/doc/90000/90136/91770)配置群机器人得到通知消息，如果不常用企业微信，那可以用[Server酱](http://sc.ftqq.com/3.version)，登录后把脚本中的Key替换成自己的就能收到通知了

#### 在腾讯云开发（CloudBase）中创建云函数和云数据库并添加云接入

在[腾讯云开发](https://console.cloud.tencent.com/tcb)中创建[云函数](https://console.cloud.tencent.com/tcb/scf)`LogPower`，选择`Nodejs 10.15`的运行环境，其中，函数代码如下：

```js
'use strict';
const tcb = require('@cloudbase/node-sdk')

const app = tcb.init({
    env: '[]'//环境Id
})
exports.main = (event, context, callback) => {
    //console.log("Hello World")
    console.log(event)
    //console.log(event["non-exist"])
    console.log(context)
    // 1. 获取数据库引用
    var db = app.database()

    db.collection('PowerLog')
        .add({
            // _id: 'todo-identifiant-aleatoire', // 可选自定义 _id，在此处场景下用数据库自动分配的就可以了            
            LogTime: new Date() ,
            DeviceName:""          
        })
        .then(res => {
            console.log("保存成功")
            console.log(res)
        })
        return {
            Msg:"LogSuccess!"
        }
    //callback(null, event);
};

```

添加一个`package.json`文件，并输入以下内容：

```json
{
  "name": "app",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {},
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@cloudbase/node-sdk": "latest"
  }
}
```

点击`保存并安装依赖`

![](/img/blog_qcloud_cloudBase_CreateHttp.png)

### 常见问题

* 脚本的执行方式

由于我登录的用户只有一般的权限，所以我使用任务计划（Task scheduler），创建一个每次连接到用户（虽然我期望的是登录用户执行我的脚本，但其实这里触发器的触发条件应该用连接用户)就执行的计划来执行这个脚本

* 连接到用户后弹出命令行执行窗口

如果你选择连接到用户后执行上述的PowerShell脚本，那会弹出一个一闪而过的命令行黑窗，参考[这个文章](https://social.technet.microsoft.com/Forums/windows/en-US/24d1b052-b56d-4a34-b39b-602ca84cf4bd/task-scheduler-hidden-powershell-with-no-popup?forum=winserverpowershell)，使用以下VBS脚本执行PowerShell代码，这样就不会弹窗了

```powershell
command = "powershell.exe -nologo -command C:\Scripts\YourScript.ps1"
 set shell = CreateObject("WScript.Shell")
 shell.Run command,0
```



